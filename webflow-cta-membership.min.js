(()=>{var e=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)},t=(t,n,s)=>(e(t,n,"read from private field"),s?s.call(t):n.get(t)),n=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},s=(t,n,s,o)=>(e(t,n,"write to private field"),o?o.call(t,s):n.set(t,s),s);(o||(o={})).getBracketed=function(e){return`[${e}]`};var o=(e=>(e.ATTR_CORE_SCRIPT_INJECT="wfu-script-load",e.ATTR_VIDEO="wfu-video",e.ATTR_VIDEO_YOUTUBE_NOREL="wfu-youtube-norel",e.ATTR_VIDEO_DATA_POSTER_URL="wfu-data-poster-url",e.ATTR_DESIGN="wfu-design",e.ATTR_ELEMENT_SLIDER="wfu-slider",e.ATTR_ELEMENT_SLIDE_NAME="wfu-slide-name",e.ATTR_ELEMENT_TABS="wfu-tabs",e.ATTR_ELEMENT_TAB_NAME="wfu-tab-name",e.ATTR_ELEMENT_BUTTON="wfu-button",e.ATTR_BUTTON_ENABLED="wfu-button-enabled",e.ATTR_BUTTON_DISABLED_CLASS="wfu-button-disabled-class",e.ATTR_ELEMENT_DECK_TARGET="wfu-deck-target",e.ATTR_ELEMENT_DECK_ACTION="wfu-deck-action",e.ATTR_ELEMENT_DECK_ITEM="wfu-deck-action-item",e.ATTR_ELEMENT_DROPDOWN="wfu-dropdown",e.ATTR_ELEMENT_DROPDOWN_NAME="wfu-dropdown-name",e.ATTR_ELEMENT_DROPDOWN_INIT="wfu-dropdown-init",e.ATTR_ELEMENT_DROPDOWN_TYPE="wfu-dropdown-type",e.ATTR_ELEMENT_AUTOCOMPLETE="wfu-autocomplete",e.ATTR_ELEMENT_AUTOCOMPLETE_INPUT="wfu-autocomplete-input",e.ATTR_ELEMENT_AUTOCOMPLETE_LIST="wfu-autocomplete-list",e.ATTR_ELEMENT_AUTOCOMPLETE_ITEM="wfu-autocomplete-item",e.ATTR_ELEMENT_AUTOCOMPLETE_ITEM_ACTION="wfu-autocomplete-item-action",e.ATTR_ELEMENT_AUTOCOMPLETE_ITEM_MATCH="wfu-autocomplete-item-match",e.ATTR_ELEMENT_AUTOCOMPLETE_ITEM_LAYOUT="wfu-autocomplete-item-layout",e.ATTR_DATA="wfu-data",e.ATTR_DATA_TYPE="wfu-data-type",e.ATTR_DATA_DSN="wfu-data-dsn",e.ATTR_DATA_ITEM_ID="wfu-data-item-id",e.ATTR_DATABIND="wfu-bind",e.ATTR_DATABIND_CONTENT="wfu-bind-content",e.ATTR_DATABIND_CONTEXT_DSN="wfu-bind-dsn",e.ATTR_DATABIND_CONTEXT_ITEM_ID="wfu-bind-item-id",e.ATTR_PRELOAD="wfu-preload",e.ATTR_IX_TRIGGER="wfu-ix-trigger",e.ATTR_IX_ID="wfu-ix-id",e.ATTR_SORT="wfu-sort",e.ATTR_SORT_DIR="wfu-sort-dir",e.ATTR_SORT_TYPE="wfu-sort-type",e.ATTR_SORT_KEY="wfu-sort-key",e.ATTR_FILTER="wfu-filter",e.ATTR_FILTER_MATCH="wfu-filter-match",e.ATTR_FILTER_EVAL="wfu-filter-eval",e.ATTR_FILTER_FUNC="wfu-filter-func",e.ATTR_HIDE="wfu-hide",e.ATTR_SUPPRESS="wfu-suppress",e.ATTR_404_SEARCH="wfu-404-search",e.ATTR_FORM_HANDLER="wfu-form-handler",e.ATTR_FORM_MESSAGE="wfu-form-message",e.ATTR_FORM_IPINFO="wfu-form-ipinfo",e.ATTR_MODAL="wfu-modal",e.ATTR_MODAL_TRIGGER="wfu-modal-trigger",e.ATTR_MODAL_CLOSE="wfu-modal-close",e.ATTR_MODAL_CLOSE_TYPE="wfu-modal-close-type",e.ATTR_MODAL_SUPPRESS_DAYS="wfu-modal-suppress-days",e.ATTR_FORMAT="wfu-format",e.ATTR_FORMAT_DATE="wfu-format-date",e.ATTR_FORMAT_HANDLER="wfu-format-handler",e.ATTR_FORMAT_MODE="wfu-format-mode",e.ATTR_FORMAT_SUFFIX="wfu-format-suffix",e.ATTR_COUNTUP="wfu-countup",e.ATTR_COUNTUP_TRIGGER="wfu-countup-trigger",e.ATTR_DEMO_LINK="wfu-demo-link",e.ATTR_LIGHTBOX_CAPTIONS="wfu-lightbox-captions",e.ATTR_LIGHTBOX_GROUP="wfu-lightbox-group",e.ATTR_DECODE="wfu-decode",e.ATTR_LIMIT_MULTIPLE="wfu-limit-multiple",e.ATTR_LIMIT_MULTIPLE_MIN="wfu-limit-multiple-min",e.ATTR_SHOW_LOGGED_IN="wfu-show-logged-in",e.ATTR_HIDE_LOGGED_IN="wfu-hide-logged-in",e.ATTR_LOGIN_BUTTON="wfu-login-button",e.ATTR_RICHTEXT_LISTS="wfu-lists",e.ATTR_RICHTEXT_LIST_THEME="wfu-list-theme",e.ATTR_URL_RELATIVE_LINKS="wfu-relative-links",e.ATTR_URL_EXTERNAL_LINKS="wfu-external-links",e.ATTR_UI_ACCORDION="wfu-ui-accordion",e.ATTR_RATING="wfu-rating",e.ATTR_GIST="wfu-gist",e.ATTR_GIST_COPY="wfu-gist-copy",e.ATTR_LAYOUT="wfu-layout",e.ATTR_LAYOUT_HANDLER="wfu-layout-handler",e.ATTR_LAYOUT_TARGET="wfu-layout-target",e.ATTR_LAYOUT_ZONE="wfu-layout-zone",e.ATTR_ELEMENTGROUP_NAME="wfu-element-name",e.ATTR_ELEMENTGROUP_GROUP="wfu-element-display",e.ATTR_ELEMENTGROUP_DEFAULT="wfu-element-default",e.ATTR_ELEMENTGROUP_DISPLAY="wfu-element-display",e.ATTR_ELEMENTGROUP_TARGETGROUP="wfu-element-target-group",e.ATTR_ELEMENTGROUP_TARGETNAME="wfu-element-target-name",e.ATTR_ELEMENTGROUP_ACTION="wfu-element-action",e))(o||{}),i=class{constructor(e){this.localStorageDebugFlag="sa5-debug",this._enabled=!1,this._label=e}get persistentDebug(){return Boolean(localStorage.getItem(this.localStorageDebugFlag))}set persistentDebug(e){e?(localStorage.setItem(this.localStorageDebugFlag,"true"),console.debug("sa5-core debug enabled (persistent).")):(localStorage.removeItem(this.localStorageDebugFlag),console.debug("sa5-core debug disabled (persistent)."))}get enabled(){var e=Boolean(localStorage.getItem(this.localStorageDebugFlag));return e=e||this._enabled}set enabled(e){this._enabled=e}group(e){this.enabled&&console.group(e)}groupEnd(){this.enabled&&console.groupEnd()}debug(...e){this.enabled&&console.debug(this._label,...e)}},r=class{constructor(){}init(){this.removeDesignTimeElements()}removeDesignTimeElements(){document.querySelectorAll(o.getBracketed("wfu-design")).forEach((e=>{e.remove()}))}},a=class{constructor(){this.handlers=[],(new r).init()}getHandlers(e){return this.handlers.filter((t=>t[0]===e)).map((e=>e[1]))}getHandler(e){const t=this.handlers.find((t=>t[0]===e));return t?t[1]:void 0}init(){this.initDebugMode(),this.initAsync()}async initAsync(){this.initScriptInjectionsAsync()}async initScriptInjectionsAsync(){document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll("script[wfu-script-load]").forEach((e=>{const t=e.getAttribute("wfu-script-load");t&&fetch(t).then((e=>e.text())).then((t=>{const n=document.createElement("script");n.textContent=t,e.replaceWith(n)})).catch((e=>{console.error("Error loading script:",e)}))}))}))}initDebugMode(){const e="debug";let t=new URLSearchParams(window.location.search);if(t.has(e)){new i("sa5 init").persistentDebug=this.stringToBoolean(t.get(e))}}stringToBoolean(e){return-1!==["1","true","yes"].indexOf(e.toLowerCase())}static startup(e=null){let t=window.sa5;var n;return"Sa5Core"==t?.constructor?.name?n=t:((n=new a).init(),Array.isArray(t)&&(n.handlers=t),window.sa5=n,window.Sa5=window.sa5),e&&(window.sa5[e.name]=e),n}push(e){this.handlers.push(e)}};function u(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}a.startup();var c,d,l,g,f,h,T,_,m=11400714785074694791n,w=14029467366897019727n,p=1609587929392839161n,A=9650029242287828579n,E=2870177450012600261n,b=2n**64n-1n,I=new TextEncoder;function R(e,t,n,s){return BigInt(e)|BigInt(t)<<16n|BigInt(n)<<32n|BigInt(s)<<48n}function L(e,t){return BigInt(e[t])|BigInt(e[t+1])<<8n|BigInt(e[t+2])<<16n|BigInt(e[t+3])<<24n|BigInt(e[t+4])<<32n|BigInt(e[t+5])<<40n|BigInt(e[t+6])<<48n|BigInt(e[t+7])<<56n}function y(e,t){return e<<t&b|e>>64n-t}function U(e){return BigInt.asUintN(64,e)}var S=class{constructor(e=0){n(this,c,void 0),n(this,d,void 0),n(this,l,void 0),n(this,g,void 0),n(this,f,void 0),n(this,h,void 0),n(this,T,void 0),n(this,_,void 0),this.reset(e)}reset(e=t(this,c)){return s(this,c,BigInt.asUintN(32,BigInt(e))),s(this,d,U(t(this,c)+m+w)),s(this,l,U(t(this,c)+w)),s(this,g,t(this,c)),s(this,f,U(t(this,c)-m)),s(this,h,null),s(this,T,0),s(this,_,0),this}update(e){"string"==typeof e&&(e=I.encode(e));let n=0,o=e.length,i=n+o;if(0===o)return this;if(s(this,T,t(this,T)+o),0===t(this,_)&&s(this,h,new Uint8Array(32)),t(this,_)+o<32)return t(this,h).set(e.subarray(0,o),t(this,_)),s(this,_,t(this,_)+o),this;if(t(this,_)>0){t(this,h).set(e.subarray(0,32-t(this,_)),t(this,_));let o,i=0;o=L(t(this,h),i),s(this,d,U(y(U(t(this,d)+o*w),31n)*m)),i+=8,o=L(this.memory,i),s(this,l,U(y(U(t(this,l)+o*w),31n)*m)),i+=8,o=L(this.memory,i),s(this,g,U(y(U(t(this,g)+o*w),31n)*m)),i+=8,o=L(this.memory,i),s(this,f,U(y(U(t(this,f)+o*w),31n)*m)),n+=32-t(this,_),s(this,_,0)}if(n<=i-32){const o=i-32;do{let o;o=L(e,n),s(this,d,U(y(U(t(this,d)+o*w),31n)*m)),n+=8,o=L(e,n),s(this,l,U(y(U(t(this,l)+o*w),31n)*m)),n+=8,o=L(e,n),s(this,g,U(y(U(t(this,g)+o*w),31n)*m)),n+=8,o=L(e,n),s(this,f,U(y(U(t(this,f)+o*w),31n)*m)),n+=8}while(n<=o)}return n<i&&(t(this,h).set(e.subarray(n,i),t(this,_)),s(this,_,i-n)),this}digest(){let e=t(this,h),n=t(this,_),s=0,o=0n,i=0n,r=0n;for(t(this,T)>=32?(o=y(t(this,d),1n)+y(t(this,l),7n)+y(t(this,g),12n)+y(t(this,f),18n),o=U(o^y(U(t(this,d)*w),31n)*m),o=U(o*m+A),o=U(o^y(U(t(this,l)*w),31n)*m),o=U(o*m+A),o=U(o^y(U(t(this,g)*w),31n)*m),o=U(o*m+A),o=U(o^y(U(t(this,f)*w),31n)*m),o=U(o*m+A)):o=U(t(this,c)+E),o+=BigInt(t(this,T));s<=n-8;)r=L(e,s),r=U(y(U(r*w),31n)*m),o=U(y(o^r,27n)*m+A),s+=8;for(s+4<=n&&(r=R(e[s+1]<<8|e[s],e[s+3]<<8|e[s+2],0,0),o=U(y(o^U(r*m),23n)*w+p),s+=4);s<n;)r=R(e[s++],0,0,0),o=U(y(o^U(r*E),11n)*m);return i=U(o>>33n),o=U((o^i)*w),i=U(o>>29n),o=U((o^i)*p),i=U(o>>32n),o=U(o^i),o}static hash(e,t=0){return new S(t).update(e).digest().toString(16)}},M=S;c=new WeakMap,d=new WeakMap,l=new WeakMap,g=new WeakMap,f=new WeakMap,h=new WeakMap,T=new WeakMap,_=new WeakMap;var O=class{constructor(){this.user_data_loaded={email:!1,account_info:!1,custom_fields:!1,access_groups:!1},this.access_groups=[],this.data={},this.meta={},this.raw={},this.isLoggedIn=function(){return u("wf_loggedin")||!1}}get user_id_alt(){if(this.email)return M.hash(this.email)}get name_short_clean(){if(this.email)return this.email.split("@")[0]}get name_short(){if(this.email)return this.name_short_clean+"@"}get name_short_tcase(){if(this.email)return this.name_short_clean.toLowerCase().split(" ").map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join(" ")}fromJSON(e){e&&(this.user_id=e.user_id,this.name=e.name,this.email=e.email,this.accept_communications=e.accept_communications,this.access_groups=e.access_groups,this.data=e.data,this.user_data_loaded.email=e.user_data_loaded.email,this.user_data_loaded.account_info=e.user_data_loaded.account_info,this.user_data_loaded.custom_fields=e.user_data_loaded.custom_fields,this.user_data_loaded.access_groups=e.user_data_loaded.access_groups,this.raw=e.raw)}},D=class{constructor(e){this._dataBinder=e}processElement(e){let t=e.innerHTML;t=t.replace(/{{(.*?)}}/g,((t,n)=>this.processItem(n,e))),e.innerHTML=t}processItem(e,t){let n=new v(e);return this._dataBinder.getData(n,t)}},v=class{get isValid(){return!!this.name&&!!this.type}constructor(e){this.parse(e)}expandDataSourceTypeAbbr(e){const t={"@":"$user","+":"$db","?":"$query","!":"$unknown","#":"$unknown","%":"$unknown","^":"$unknown","&":"$unknown","*":"$unknown","=":"$unknown","-":"$unknown","~":"$unknown"};return t.hasOwnProperty(e[0])?t[e[0]]+"."+e.slice(1):e}parse(e){this.name=void 0,this.type=void 0,e=e.trim();let t=(e=this.expandDataSourceTypeAbbr(e)).split(".");var n=t.shift();"$"==n[0]&&(n=n.slice(1),this.identifierParts=t,this.name=this.identifierParts.join("."),this.type=n)}},N=class{constructor(e,t={}){this.store=e,this.config={db:t.db??null,user:t.user??null,handlers:[]},this.config.user||(this.config.user=(new B).loadUserInfoCache())}bindAll(){document.querySelectorAll("[wfu-bind]").forEach((e=>{this.bind(e),e.removeAttribute("wfu-preload")})),document.querySelectorAll("[wfu-bind-content]").forEach((e=>{this.bindContent(e),e.removeAttribute("wfu-preload")}))}findContextSetting(e,t){for(;e;){if(null!==e.getAttribute(t))return e.getAttribute(t);e=e.parentElement}return null}bind(e){let t=e.getAttribute("wfu-bind"),n=new v(t);if(!n.isValid)return void console.error("Invalid dsn.",n);let s=null;if(s=this.getData(n,e),s)switch(function(e){switch(e.tagName){case"A":return"HTMLLinkElement";case"INPUT":switch(e.type){case"checkbox":return"HTMLCheckboxElement";case"radio":return"HTMLRadioElement";case"file":return"HTMLFileInputElement";default:return"HTMLInputElement"}case"SELECT":return"HTMLSelectElement";case"TEXTAREA":return"HTMLTextAreaElement";case"BUTTON":return"HTMLButtonElement";default:return"HTMLElement"}}(e)){case"HTMLLinkElement":e.href=s;break;case"HTMLCheckboxElement":e.checked=function(e){switch(e.toLowerCase()){case"false":case"f":case"":case"0":case"no":case"off":case void 0:case"undefined":case null:case"null":return!1;default:return!0}}(s);break;case"HTMLRadioElement":case"HTMLFileInputElement":case"HTMLButtonElement":break;case"HTMLInputElement":case"HTMLTextAreaElement":e.value=s;break;case"HTMLSelectElement":!function(e,t){for(let n=0;n<e.options.length;n++)if(e.options[n].value===t){e.options[n].selected=!0;break}}(e,s);break;default:e.textContent=s}}bindContent(e){new D(this).processElement(e)}getData(e,t=null){switch(e.type){case"user":return this.getData_user(e);case"db":let n=this.findContextSetting(t,"wfu-bind-dsn"),s=this.findContextSetting(t,"wfu-bind-item-id");return this.getData_db(e,n,s);case"query":return this.getData_query(e);case"url":return this.getData_url(e);case"local":return this.getData_localStorage(e);case"session":return this.getData_sessionStorage(e);case"cookie":return this.getData_cookieStorage(e)}}getData_user(e){if(!this.config.user||!this.config.user.email)return null;let t="";if("data"===e.identifierParts[0])t=this.config.user.data[e.identifierParts[1]];else t=this.config.user[e.name];return t}getData_cookieStorage(e){return"undefined"==typeof window?null:u(e.name)}getData_localStorage(e){return"undefined"==typeof window?null:localStorage.getItem(e.name)}getData_sessionStorage(e){return"undefined"==typeof window?null:sessionStorage.getItem(e.name)}getData_query(e){if("undefined"==typeof window)return null;return new URLSearchParams(window.location.search).get(e.name)}getData_url(e){if("undefined"==typeof window)return null;const t=new URL(window.location.href)[e.name];return console.log(t),t}getData_db(e,t,n){return this.store.store[t].data.get(n)[e.name]}},C=class{constructor(e){this.accessGroups=[],this.membership=e}async initAsync(){console.log("initAsync"),console.log(await this.getAccessGroupsAsync())}async getAccessGroupsAsync(){this.accessGroups=[];for(let e of this.membership.config.accessGroups){await this.checkAccessGroupAsync(e)&&this.accessGroups.push(e)}return this.accessGroups}async checkAccessGroupAsync(e){const t=await fetch(`${this.membership.config.accessGroupsFolder}/${e}`);return console.log(`redirected: ${t.redirected}`),console.log("STATUS:",t.status),t.redirected?(200!=t.status&&console.warn("SA5",`Memberships configuration error- access group ${e} is not queryable.`),console.log(`Not logged in, or no access to ${e}`),!1):(console.log(`Has access group ${e}`),!0)}},k=class{constructor(e){this.accessGroups=[],this.membership=e}async initAsync(){console.log("initAsync"),console.log(await this.getCurrentUserAsync())}async getCurrentUserAsync(){const e=await fetch(`${this.membership.config.hf.currentUserUrl}`);console.log("STATUS:",e.status);const t=await e.json();console.log(t)}},P=Object.freeze({user:"wfuUser",userKey:"wfuUserKey"}),B=class{constructor(e={}){this.userInfoUpdatedCallback=e=>{this.config.userInfoUpdatedCallback&&this.config.userInfoUpdatedCallback(e)},this.config={userInfoUpdatedCallback:e.userInfoUpdatedCallback,debug:e.debug??!1,dataBind:e.dataBind??!0,accessGroupsFolder:e.accessGroupsFolder??"/sa5-ag",accessGroups:e.accessGroups??null,advanced:{accountInfoLoadDelay:e.advanced?.accountInfoLoadDelay??300,accountInfoSaveDelay:e.advanced?.accountInfoSaveDelay??500},hf:{enabled:e.hf?.enabled??!1,currentUserUrl:e.hf?.currentUserUrl??"/_hf/users/current_user"}};a.startup();this.debug=new i("sa5-membership"),this.debug.debug("Initializing")}isUserInfoChangedCallback(e){return!!e&&1===e.length}onUserInfoChanged(e){let t=a.startup();console.log(t);t.getHandlers("userInfoChanged").forEach((t=>{this.isUserInfoChangedCallback(t)&&t(e)}))}init(){this.debug.group(`SA5 UserInfo init - ${Date.now()}.`);let e=a.startup().getHandler("getMembershipConfig");if(!e)return;e&&(this.config=e(this.config));let t=document.querySelectorAll("form[data-wf-user-form-type='login']");t.forEach((e=>{e.addEventListener("submit",(t=>{let n=e.querySelector("#wf-log-in-email").value,s=btoa(n);localStorage.setItem("StorageKeys.userKey",s)}))})),t=document.querySelectorAll("form[data-wf-user-form-type='userAccount']"),t.forEach((e=>{e.addEventListener("submit",(e=>{setTimeout((async()=>{await this.loadUserInfoAsync()}),this.config.advanced.accountInfoSaveDelay)}))})),this.readyUserInfo(),this.debug.groupEnd()}isLoggedIn(){return u("wf_loggedin")||!1}clearUserInfo(){this.debug.group("clearUserInfo"),this.debug.debug("logged out, cleaning info."),sessionStorage.removeItem(P.user),localStorage.removeItem(P.userKey),this.debug.groupEnd()}async readyUserInfo(){if(this.debug.group("readyUserInfo"),!this.isLoggedIn())return this.clearUserInfo(),void this.debug.groupEnd();var e=this.loadUserInfoCache();e&&(this.config.dataBind&&(this.debug.debug("databinding",e),new N(null,{user:e}).bindAll()),this.onUserInfoChanged(e)),e||await this.loadUserInfoAsync(),this.debug.groupEnd()}async getUserKey(){const e=localStorage.getItem(P.userKey);if(e)return atob(e)}async loadUserInfoAsync(){if(this.debug.group("loadUserInfoAsync"),this.debug.debug(`isLoggedIn = ${this.isLoggedIn()}`),!this.isLoggedIn())return this.clearUserInfo(),void this.debug.groupEnd();sessionStorage.removeItem(P.user),this.config.hf.enabled?this.loadUserInfoAsync_hyperflow():(this.loadUserInfoAsync_loginInfo(),this.loadUserInfoAsync_accountInfo(),this.loadUserInfoAsync_accessGroups()),this.debug.groupEnd()}async loadUserInfoAsync_hyperflow(){this.debug.group("loadUserInfoAsync_hyperflow");var e=new O;e.user_data_loaded.email=!0,e.user_data_loaded.account_info=!0,e.user_data_loaded.access_groups=!0;const t=new k(this);await t.initAsync(),this.debug.debug("Caching user object [login].",e),this.saveUserInfoCache(e),this.debug.groupEnd()}async loadUserInfoAsync_loginInfo(){this.debug.group("loadUserInfoAsync_loginInfo");var e=new O;e.user_data_loaded.email=!0;const t=await this.getUserKey();if(!t)return this.debug.debug("No user key for loading."),void this.debug.groupEnd();e.email=t,this.debug.debug("Caching user object [login].",e),this.saveUserInfoCache(e),this.debug.groupEnd()}async loadUserInfoAsync_accountInfo(){if(this.debug.group("loadUserInfoAsync_accountInfo"),window.self!=window.top)return;let e=document.createElement("iframe");e.src="/user-account",e.id="userInfoPixel",e.style.display="none",document.body.append(e),e.addEventListener("load",(async()=>{this.debug.debug("Loading user account info."),this.debug.debug("%c here","color: #ff0000; background-color: yellow;");var t=new O;t.user_data_loaded.email=!0,t.user_data_loaded.account_info=!0,t.user_data_loaded.custom_fields=!0;let n=null;if(e.contentDocument?n=e.contentDocument.querySelector("input#wf-user-account-email"):e.contentWindow&&(n=e.contentWindow.document.querySelector("input#wf-user-account-email")),!n)return;const s=n,o=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value");Object.defineProperty(s,"value",{get:o.get,set:function(e){if(o.set.call(this,e),"createEvent"in document){var t=document.createEvent("HTMLEvents");t.initEvent("change",!1,!0),s.dispatchEvent(t)}else if(n){let e=new Event("change",{bubbles:!0,cancelable:!0});n.dispatchEvent(e)}}}),n.addEventListener("change",(async()=>{this.debug.debug("email field load detected."),this.debug.debug(`waiting ${this.config.advanced.accountInfoLoadDelay}ms`),setTimeout((async()=>{this.debug.debug("%c USER-ACCOUNT LOADED","color: #ff0000; background-color: yellow;");const s=n.value;t.email=s;let o=e.contentDocument||e.contentWindow?.document;if(o){let e=o.querySelector("[data-wf-user-field='wf-user-field-name']");e&&(t.name=e.value);let n=o.querySelector("#wf-user-account-accept-communications");n&&(t.accept_communications=n.checked),o.querySelectorAll("[data-wf-user-field]").forEach((e=>{const n=e.id,s=e.getAttribute("data-wf-user-field-type");let o=e.value;if(n&&!n.startsWith("wf-user-account-"))switch(s){case"PlainText":case"Email":case"Link":case"Option":case"Number":return void(t.data[n]=o);case"Bool":let s=e;return void(t.data[n]=s.checked)}}))}this.debug.debug("Final version",t),this.debug.debug("Caching user object [account_info].",t),this.saveUserInfoCache(t)}),this.config.advanced.accountInfoLoadDelay)})),this.debug.groupEnd()}))}async loadUserInfoAsync_accessGroups(){this.debug.group("loadUserInfoAsync_accessGroups");var e=new O;if(e.user_data_loaded.access_groups=!0,this.config.accessGroups){let t=new C(this);await t.initAsync(),e.access_groups=t.accessGroups}else this.debug.debug("Access groups not configured.");this.debug.debug("Caching user object [login].",e),this.saveUserInfoCache(e),this.debug.groupEnd()}saveUserInfoCache(e){if(this.debug.group("saveUserInfoCache"),!this.isLoggedIn)return this.debug.debug("no user logged in."),this.debug.groupEnd(),null;var t=this.loadUserInfoCache();t||(t=new O),e.user_data_loaded.email&&(this.debug.debug("Merging user email."),t.email=e.email),e.user_data_loaded.account_info&&(this.debug.debug("Merging user account_info."),t.email=e.email,t.name=e.name,t.accept_communications=e.accept_communications),e.user_data_loaded.custom_fields&&(this.debug.debug("Merging user custom_fields."),t.data=e.data),e.user_data_loaded.access_groups&&(this.debug.debug("Merging user access_groups."),t.access_groups=e.access_groups),t.user_data_loaded.email=t.user_data_loaded.email||e.user_data_loaded.email,t.user_data_loaded.account_info=t.user_data_loaded.account_info||e.user_data_loaded.account_info,t.user_data_loaded.custom_fields=t.user_data_loaded.custom_fields||e.user_data_loaded.custom_fields,t.user_data_loaded.access_groups=t.user_data_loaded.access_groups||e.user_data_loaded.access_groups,this.debug.debug("new user",e),this.debug.debug("merged",t),sessionStorage.setItem(P.user,btoa(JSON.stringify(t))),this.config.dataBind&&(this.debug.debug("databinding",t),new N(null,{user:t}).bindAll()),this.onUserInfoChanged(t),this.debug.groupEnd()}loadUserInfoCache(){if(this.debug.group("loadUserInfoCache"),!this.isLoggedIn)return this.debug.debug("No user logged in."),this.debug.groupEnd(),null;const e=sessionStorage.getItem(P.user);if(!e)return this.debug.debug("No user info to load."),this.debug.groupEnd(),null;this.debug.debug(e),this.debug.debug("getting user.");const t=new O;return t.fromJSON(JSON.parse(atob(e))),this.debug.groupEnd(),t}expandLoginButton(e){const t=e.querySelector("[data-wf-user-logout]");e.addEventListener("click",(()=>{t&&t.click()})),t&&t.addEventListener("click",(e=>{e.stopPropagation()}))}},G=class{constructor(e={}){this.config={routeAfterFirstLogin:e.routeAfterFirstLogin??"/",routeAfterLogin:e.routeAfterLogin??"/"},this.debug=new i("sa5-membership-routing"),this.debug.debug("Initializing")}init(){let e=a.startup().getHandler("getMembershipRoutingConfig");e&&e&&(this.config=e(this.config),console.log("config handler",this.config),this.routeUser())}routeUser(){this.routeAfterFirstLogin()||this.routeAfterLogin()}routeAfterFirstLogin(){if("/"!=window.location.pathname&&"/log-in"!=window.location.pathname)return!1;if(!this.config.routeAfterFirstLogin)return!1;if(!document.referrer)return!1;if("/sign-up"!=new URL(document.referrer).pathname)return!1;switch(window.location.pathname){case"/":window.location.replace(this.config.routeAfterFirstLogin);break;case"/log-in":this.setLoginPageRedirect(this.config.routeAfterFirstLogin)}return!0}routeAfterLogin(){if(console.group("wfu routeAfterLogin"),!this.config.routeAfterLogin)return console.debug("no routeafterlogin config set."),console.groupEnd(),!1;if(!document.querySelectorAll("form[data-wf-user-form-type='login']").length)return console.debug("no login forms found."),console.groupEnd(),!1;var e=new URL(window.location.href);console.debug(`url: ${e.href}`),console.debug(`referrer: ${document.referrer}`);var t="";if(document.referrer&&(t=new URL(document.referrer).pathname),e.searchParams.has("usredir"))return console.debug("specific redirection specified."),console.groupEnd(),!1;var n=this.config.routeAfterLogin;if(console.debug(`default routePath: ${n}`),"."==n)if("/log-in"==e.pathname)switch(t){case"":case"/log-in":case"/sign-up":n="/";default:n=t}else n=e.pathname;return console.debug(`routePath: ${n}`),this.setLoginPageRedirect(n),console.groupEnd(),!0}setLoginPageRedirect(e){document.querySelectorAll("form[data-wf-user-form-type='login']").forEach((function(t){t.setAttribute("data-wf-user-form-redirect",e)}))}logout(){fetch("/.wf_graphql/csrf",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{console.log("CSRF Response:",e);let t=document.cookie.split("; ").find((e=>e.startsWith("wf-csrf="))).split("=")[1];return fetch("/.wf_graphql/usys/apollo",{method:"POST",headers:{"Content-Type":"application/json","X-Wf-Csrf":t},body:JSON.stringify([{operationName:"UserLogoutRequest",variables:{},query:"mutation UserLogoutRequest {\n  usysDestroySession {\n    ok\n    __typename\n  }\n}\n"}])})})).then((e=>e.json())).then((e=>{console.log("Apollo Response:",e)})).catch((e=>{console.error("Error:",e)}))}},H=()=>{let e=new B;a.startup();new i("sa5-user-accounts").debug("Initializing 5.4.0"),console.debug(`isLoggedIn = %c${e.isLoggedIn()}`,"color: #ff0000;"),document.querySelectorAll(o.getBracketed("wfu-show-logged-in")).forEach((t=>{e.isLoggedIn()&&t.removeAttribute("wfu-show-logged-in")})),document.querySelectorAll(o.getBracketed("wfu-hide-logged-in")).forEach((t=>{e.isLoggedIn()||t.removeAttribute("wfu-hide-logged-in")})),document.querySelectorAll(o.getBracketed("wfu-login-button")).forEach((t=>{e.expandLoginButton(t)})),e.init(),(new G).init()};"loading"!==document.readyState?H():document.addEventListener("DOMContentLoaded",H)})();